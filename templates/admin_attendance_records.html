<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Attendance Records - FaceCheck</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <style>
        /* Navbar color update */
        .navbar-custom {
            background-color: #339CFF;
        }
        .navbar-custom .navbar-brand,
        .navbar-custom .btn-outline-light {
            color: white;
        }

        /* Table header color update */
        .table-custom thead {
            background-color: #339CFF;
            color: white;
        }
    </style>
</head>
<body class="bg-light">

<nav class="navbar navbar-expand-lg navbar-custom">
    <div class="container-fluid">
        <a class="navbar-brand" href="#">FaceCheck</a>
        <div class="d-flex">
            <a href="{{ url_for('admin_dashboard') }}" class="btn btn-outline-light btn-sm me-2">Dashboard</a>
            <a href="{{ url_for('admin_logout') }}" class="btn btn-outline-light btn-sm">Logout</a>
        </div>
    </div>
</nav>

<div class="container mt-4">
    <h3 class="text-center mb-4">Attendance Records</h3>

    <!-- ðŸ”¹ Filters -->
    <div class="row g-3 mb-3 justify-content-center">
        <div class="col-md-3">
            <input type="date" id="dateFilter" class="form-control" value="{{ selected_date or '' }}">
        </div>
        <div class="col-md-3">
            <input type="text" id="rollFilter" class="form-control" placeholder="Enter Roll No" value="{{ selected_roll or '' }}">
        </div>
        <div class="col-md-3">
            <select id="classFilter" class="form-select">
                <option value="">All Classes</option>
                {% for cls in classes %}
                <option value="{{ cls }}">{{ cls }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-3">
            <select id="subjectFilter" class="form-select">
                <option value="">All Subjects</option>
                {% for sub in subjects %}
                <option value="{{ sub }}">{{ sub }}</option>
                {% endfor %}
            </select>
        </div>
    </div>

    <!-- ðŸ”¹ Clear All Attendance Button -->
    <div class="d-flex justify-content-center mb-3">
        <button id="clearAttendanceBtn" class="btn btn-danger btn-lg">
            <i class="fa-solid fa-trash"></i> Clear All Attendance
        </button>
    </div>

    <!-- Attendance Table -->
    <div class="card shadow rounded-3">
        <div class="card-body">
            {% if attendance %}
            <table class="table table-bordered table-hover text-center align-middle table-custom" id="attendanceTable">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Name</th>
                        <th>Roll No</th>
                        <th>Class</th>
                        <th>Subject</th>
                    </tr>
                </thead>
                <tbody>
                    {% for rec in attendance %}
                    <tr data-class="{{ rec['class_name'] }}" 
                        data-subject="{{ rec['subject'] }}"
                        data-date="{{ rec['date'] }}"
                        data-roll="{{ rec['roll_no'] }}">
                        <td>{{ rec['date'] }}</td>
                        <td>{{ rec['full_name'] }}</td>
                        <td>{{ rec['roll_no'] }}</td>
                        <td>{{ rec['class_name'] }}</td>
                        <td>{{ rec['subject'] }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <p class="text-center text-muted">No attendance records found.</p>
            {% endif %}
        </div>
    </div>
</div>

<script>
const dateFilter = document.getElementById('dateFilter');
const rollFilter = document.getElementById('rollFilter');
const classFilter = document.getElementById('classFilter');
const subjectFilter = document.getElementById('subjectFilter');
const table = document.getElementById('attendanceTable');

function filterTable(){
    const dateVal = dateFilter.value;
    const rollVal = rollFilter.value.trim().toLowerCase();
    const classVal = classFilter.value;
    const subjectVal = subjectFilter.value;

    for(const row of table.tBodies[0].rows){
        const rowDate = row.dataset.date;
        const rowRoll = row.dataset.roll.toLowerCase();
        const rowClass = row.dataset.class;
        const rowSubject = row.dataset.subject;

        row.style.display = (
            (dateVal==='' || rowDate===dateVal) &&
            (rollVal==='' || rowRoll.includes(rollVal)) &&
            (classVal==='' || rowClass===classVal) &&
            (subjectVal==='' || rowSubject===subjectVal)
        ) ? '' : 'none';
    }
}

[dateFilter, rollFilter, classFilter, subjectFilter].forEach(el => {
    el.addEventListener('input', filterTable);
});

// ðŸ”¹ Clear All Attendance button logic
const clearBtn = document.getElementById('clearAttendanceBtn');
clearBtn.addEventListener('click', async () => {
    if(!confirm("Are you sure you want to delete all attendance records?")) return;

    try {
        const res = await axios.post('/api/clear_attendance');
        if(res.data.status === 'ok'){
            alert("All attendance records have been deleted successfully.");
            // Remove all rows from table visually
            if(table) {
                const tbody = table.tBodies[0];
                while(tbody.firstChild){ tbody.removeChild(tbody.firstChild); }
            }
        } else {
            alert("Error clearing attendance records.");
        }
    } catch(err){
        console.error(err);
        alert("Error clearing attendance records.");
    }
});
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
</body>
</html>
